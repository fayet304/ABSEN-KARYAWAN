<script>
    // --- Configuration ---
    // PASTE YOUR APPS SCRIPT URL HERE
    const appsScriptUrl = "PASTE_YOUR_APPS_SCRIPT_URL_HERE";

    // Global variable for the timer interval
    let timerInterval = null;
    let captchaCode = '';
    let currentIzinType = null;
    let izinTimerSeconds = 0;
    let timerWarningShown = false;

    // --- Modal controls ---
    function openModal(id) {
        document.getElementById(id).style.display = "flex";
        setTimeout(() => {
            document.getElementById(id).classList.add('open');
        }, 10);

        if (id === 'modalDaftar') {
            generateCaptcha();
        }
    }

    function closeModal(id) {
        const modal = document.getElementById(id);
        modal.classList.remove('open');
        setTimeout(() => {
            modal.style.display = "none";
        }, 400);

        // Reset messages and forms on close
        if (id === "modalDaftar") {
            document.getElementById("formDaftar").reset();
            document.getElementById("daftarMessage").textContent = "";
        }
    }

    // Tutup modal jika klik di luar konten modal
    window.onclick = function (event) {
        const modalDaftar = document.getElementById("modalDaftar");
        const modalLupa = document.getElementById("modalLupa");
        const modalEdit = document.getElementById("modalEditUser");
        const modalIzin = document.getElementById("modalPilihanIzin");
        const modalAbsen = document.getElementById("modalAbsenMasuk");
        const modalPulang = document.getElementById("modalAbsenPulang");
        if (event.target === modalDaftar) {
            closeModal('modalDaftar');
        }
        if (event.target === modalLupa) {
            closeModal('modalLupa');
        }
        if (event.target === modalEdit) {
            closeModal('modalEditUser');
        }
        if (event.target === modalIzin) {
            closeModal('modalPilihanIzin');
        }
        if (event.target === modalAbsen) {
            closeModal('modalAbsenMasuk');
        }
        if (event.target === modalPulang) {
            closeModal('modalAbsenPulang');
        }
    };

    // --- Login & Register ---
    window.onload = function () {
        const isLoggedIn = localStorage.getItem("isLoggedIn");
        if (isLoggedIn === "true") {
            document.getElementById("loginPage").style.display = "none";
            document.getElementById("menuPage").style.display = "flex";
            checkUserRoleAndDisplayMenu();
            showPage("aktivitasBaru");
        }
    };

    function checkUserRoleAndDisplayMenu() {
        const currentUser = localStorage.getItem("currentUser");
        const users = JSON.parse(localStorage.getItem("userAccounts") || "[]");
        const user = users.find(u => u.username === currentUser);

        const menuDataUser = document.getElementById("menuDataUser");
        if (menuDataUser) {
            if (user && user.role === "Admin") {
                menuDataUser.style.display = "list-item";
            } else {
                menuDataUser.style.display = "none";
            }
        }

    }

    function handleLogin(e) {
        e.preventDefault();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        let users = JSON.parse(localStorage.getItem("userAccounts") || "[]");
        const adminUser = { username: "admin", password: "12345", role: "Admin", nama: "Admin", divisi: "Admin", email: "admin@example.com", shift: "" };

        if (!users.find(u => u.username === "admin")) {
            users.unshift(adminUser);
            localStorage.setItem("userAccounts", JSON.stringify(users));
        }

        let userFound = users.find(u => u.username === username && u.password === password);

        if (userFound) {
            localStorage.setItem("isLoggedIn", "true");
            localStorage.setItem("currentUser", userFound.username);
            localStorage.setItem("currentUserName", userFound.nama);

            document.getElementById("loginPage").style.display = "none";
            document.getElementById("menuPage").style.display = "flex";

            checkUserRoleAndDisplayMenu();

            const logs = JSON.parse(localStorage.getItem("loginLogs") || "[]");
            const now = new Date();
            const waktu = now.toLocaleString('id-ID');
            const agent = /Mobi/i.test(navigator.userAgent) ? "Mobile Browser" : "Desktop Browser";
            const ip = "192.168.1." + Math.floor(Math.random() * 100 + 1);
            logs.push({ nama: userFound.nama, waktu, agent, ip });
            localStorage.setItem("loginLogs", JSON.stringify(logs));

            showPage('aktivitasBaru');
        } else {
            alert("Login gagal! Username atau password salah.");
        }
    }

    function generateCaptcha() {
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let captcha = '';
        for (let i = 0; i < 6; i++) {
            captcha += characters.charAt(Math.floor(Math.random() * characters.length));
        }
        captchaCode = captcha;
        document.getElementById('captchaText').textContent = captchaCode;
    }

    function handleDaftar(e) {
        e.preventDefault();
        const namaLengkap = document.getElementById('daftarNamaLengkap').value.trim();
        const password = document.getElementById('daftarPassword').value;
        const divisi = document.getElementById('daftarDivisi').value.trim();
        const email = document.getElementById('daftarEmail').value.trim();
        const captchaInput = document.getElementById('captchaInput').value;
        const daftarMessage = document.getElementById('daftarMessage');

        if (captchaInput !== captchaCode) {
            daftarMessage.textContent = 'Kode CAPTCHA salah!';
            daftarMessage.style.color = 'var(--danger-color)';
            generateCaptcha();
            return;
        }

        let users = JSON.parse(localStorage.getItem("userAccounts") || "[]");
        const existingUser = users.find(u => u.username === namaLengkap);
        const existingEmail = users.find(u => u.email === email);

        if (existingUser) {
            daftarMessage.textContent = 'Nama Lengkap sudah terdaftar sebagai username.';
            daftarMessage.style.color = 'var(--danger-color)';
            return;
        }

        if (existingEmail) {
            daftarMessage.textContent = 'Email sudah terdaftar.';
            daftarMessage.style.color = 'var(--danger-color)';
            return;
        }

        const newUser = {
            nama: namaLengkap,
            username: namaLengkap,
            password: password,
            divisi: divisi,
            email: email,
            role: 'User',
            shift: ''
        };

        users.push(newUser);
        localStorage.setItem("userAccounts", JSON.stringify(users));

        // Save to Google Sheet
        saveRegistration(newUser);

        daftarMessage.innerHTML = `Pendaftaran berhasil! Akun Anda telah dibuat dengan username **${namaLengkap}**. Silakan login.`;
        daftarMessage.style.color = 'var(--success-color)';

        document.getElementById("formDaftar").reset();
        generateCaptcha();
    }

    function logout() {
        localStorage.setItem("isLoggedIn", "false");
        localStorage.removeItem("currentUser");
        localStorage.removeItem("currentUserName");
        location.reload();
    }

    // --- Navigation ---
    function showPage(pageName) {
        const contentArea = document.getElementById('contentArea');
        contentArea.innerHTML = '';

        switch (pageName) {
            case 'tambahPemain':
                if (localStorage.getItem("currentUser") === "admin") {
                    generateUserTable();
                } else {
                    contentArea.innerHTML = `
                        <div class="floating-box" style="text-align:center;">
                            <h1>Akses Ditolak</h1>
                            <p>Anda tidak memiliki izin untuk melihat halaman ini.</p>
                        </div>
                    `;
                }
                break;
            case 'riwayatLogin':
                generateLoginHistory();
                break;
            case 'aktivitasBaru':
                generateAktivitasPage();
                break;
            case 'historyAktivitas':
                generateHistoryAktivitas();
                break;
        }
    }

    // --- Dynamic Content Generation ---
    function generateUserTable() {
        const contentArea = document.getElementById('contentArea');
        let users = JSON.parse(localStorage.getItem("userAccounts") || "[]");

        let tableHTML = `
            <div class="content-header">
                <h1>Data User</h1>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Nama Lengkap</th>
                        <th>Divisi</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Shift</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
        `;

        users.forEach(user => {
            tableHTML += `
                <tr>
                    <td>${user.username}</td>
                    <td>${user.nama}</td>
                    <td>${user.divisi}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td>
                    <td>${user.shift}</td>
                    <td>
                        <button class="edit-btn" onclick="editUser('${user.username}')">Edit</button>
                        <button class="delete-btn" onclick="deleteUser('${user.username}')">Hapus</button>
                    </td>
                </tr>
            `;
        });

        tableHTML += `
                </tbody>
            </table>
        `;
        contentArea.innerHTML = tableHTML;
    }

    function generateLoginHistory() {
        const contentArea = document.getElementById('contentArea');
        const logs = JSON.parse(localStorage.getItem("loginLogs") || "[]");

        let tableHTML = `
            <div class="content-header">
                <h1>Riwayat Login</h1>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Nama</th>
                        <th>Waktu Login</th>
                        <th>Perangkat</th>
                        <th>IP Address</th>
                    </tr>
                </thead>
                <tbody>
        `;

        logs.reverse().forEach(log => {
            tableHTML += `
                <tr>
                    <td>${log.nama}</td>
                    <td>${log.waktu}</td>
                    <td>${log.agent}</td>
                    <td>${log.ip}</td>
                </tr>
            `;
        });

        tableHTML += `
                </tbody>
            </table>
        `;
        contentArea.innerHTML = tableHTML;
    }

    function generateAktivitasPage() {
        const contentArea = document.getElementById('contentArea');
        const currentUser = localStorage.getItem("currentUser");
        const currentUserName = localStorage.getItem("currentUserName");
        const userActivities = JSON.parse(localStorage.getItem("userActivities") || "{}");
        const today = new Date().toDateString();
        const hasAbsenMasuk = userActivities[currentUser] && userActivities[currentUser][today] && userActivities[currentUser][today].absenMasuk;

        contentArea.innerHTML = `
            <div class="content-header">
                <h1>Selamat Datang, ${currentUserName}!</h1>
            </div>
            <div id="welcomeMessage">
                Absen Masuk untuk hari ini adalah <strong>WAJIB</strong>. Silakan pilih shift Anda.
            </div>
            <div class="aktivitas-container">
                <div class="aktivitas-card" id="absenMasukCard">
                    <i class="fa-solid fa-clock icon"></i>
                    <h3>Absen Masuk</h3>
                </div>
                <div class="aktivitas-card izin" id="izinCard">
                    <i class="fa-solid fa-person-walking-arrow-right icon"></i>
                    <h3>Izin</h3>
                </div>
                <div class="aktivitas-card pulang" id="absenPulangCard">
                    <i class="fa-solid fa-door-closed icon"></i>
                    <h3>Absen Pulang</h3>
                </div>
            </div>
            <div id="izinTimerContainer"></div>
        `;

        // Event listeners for activity cards
        document.getElementById('absenMasukCard').addEventListener('click', () => {
            if (!hasAbsenMasuk) {
                openModal('modalAbsenMasuk');
            } else {
                alert('Anda sudah absen masuk hari ini.');
            }
        });
        document.getElementById('izinCard').addEventListener('click', () => {
            if (hasAbsenMasuk) {
                openModal('modalPilihanIzin');
            } else {
                alert('Silakan absen masuk terlebih dahulu.');
            }
        });
        document.getElementById('absenPulangCard').addEventListener('click', () => {
            if (hasAbsenMasuk) {
                openModal('modalAbsenPulang');
            } else {
                alert('Silakan absen masuk terlebih dahulu.');
            }
        });
    }

    // Fungsi generateHistoryAktivitas yang telah diperbarui
    function generateHistoryAktivitas() {
        const contentArea = document.getElementById('contentArea');
        const currentUser = localStorage.getItem("currentUser");
        const userActivities = JSON.parse(localStorage.getItem("userActivities") || "{}");
        const today = new Date().toDateString();

        let historyHTML = `
            <div class="content-header">
                <h1>History Aktivitas</h1>
            </div>
            <div class="floating-box">
                <h2>Riwayat Aktivitas Anda</h2>
                <p>Waktu Izin Hari Ini: <strong id="totalIzinTime">00:00:00</strong></p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Tanggal</th>
                        <th>Aktivitas</th>
                        <th>Keterangan</th>
                        <th>Waktu</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                </tbody>
            </table>
        `;
        contentArea.innerHTML = historyHTML;

        const activitiesForUser = userActivities[currentUser] || {};
        const historyTableBody = document.getElementById('historyTableBody');

        let izinTimeToday = 0;
        const todayActivities = activitiesForUser[today] || {};

        if (todayActivities.izin) {
            todayActivities.izin.forEach(izin => {
                izinTimeToday += parseDurationToSeconds(izin.durasi);
            });
        }

        document.getElementById('totalIzinTime').textContent = formatTime(izinTimeToday);

        // Generate full history table
        for (const date in activitiesForUser) {
            const activities = activitiesForUser[date];
            if (activities.absenMasuk) {
                const absensiMasukRow = `
                    <tr>
                        <td>${date}</td>
                        <td>Absen Masuk</td>
                        <td>Shift ${activities.absenMasuk.shift}</td>
                        <td>${activities.absenMasuk.waktu}</td>
                    </tr>
                `;
                historyTableBody.innerHTML += absensiMasukRow;
            }

            if (activities.izin) {
                activities.izin.forEach(izin => {
                    const izinRow = `
                        <tr>
                            <td>${date}</td>
                            <td>Izin</td>
                            <td>${izin.keterangan} (${izin.durasi})</td>
                            <td>${izin.waktuMulai}</td>
                        </tr>
                    `;
                    historyTableBody.innerHTML += izinRow;
                });
            }

            if (activities.absenPulang) {
                const absensiPulangRow = `
                    <tr>
                        <td>${date}</td>
                        <td>Absen Pulang</td>
                        <td>-</td>
                        <td>${activities.absenPulang.waktu}</td>
                    </tr>
                `;
                historyTableBody.innerHTML += absensiPulangRow;
            }
        }
    }

    // --- CRUD Operations for Users (Admin Only) ---
    function editUser(usernameToEdit) {
        const users = JSON.parse(localStorage.getItem("userAccounts"));
        const user = users.find(u => u.username === usernameToEdit);
        if (!user) return;

        document.getElementById('editOriginalUsername').value = user.username;
        document.getElementById('editRole').value = user.role;
        document.getElementById('editShift').value = user.shift;
        document.getElementById('editUsername').value = user.username;
        document.getElementById('editPassword').value = user.password;
        document.getElementById('editDivisi').value = user.divisi;
        document.getElementById('editEmail').value = user.email;

        openModal('modalEditUser');
    }

    function submitEditUser(e) {
        e.preventDefault();
        const originalUsername = document.getElementById('editOriginalUsername').value;
        const newRole = document.getElementById('editRole').value;
        const newShift = document.getElementById('editShift').value;
        const newUsername = document.getElementById('editUsername').value;
        const newPassword = document.getElementById('editPassword').value;
        const newDivisi = document.getElementById('editDivisi').value;
        const newEmail = document.getElementById('editEmail').value;
        const editMessage = document.getElementById('editMessage');

        let users = JSON.parse(localStorage.getItem("userAccounts"));
        const userIndex = users.findIndex(u => u.username === originalUsername);
        if (userIndex === -1) {
            editMessage.textContent = "User tidak ditemukan.";
            editMessage.style.color = 'var(--danger-color)';
            return;
        }

        // Check for duplicate username/email if they are changed
        if (newUsername !== originalUsername && users.find(u => u.username === newUsername)) {
            editMessage.textContent = 'Username sudah ada.';
            editMessage.style.color = 'var(--danger-color)';
            return;
        }
        if (newEmail !== users[userIndex].email && users.find(u => u.email === newEmail)) {
            editMessage.textContent = 'Email sudah ada.';
            editMessage.style.color = 'var(--danger-color)';
            return;
        }

        users[userIndex].role = newRole;
        users[userIndex].shift = newShift;
        users[userIndex].username = newUsername;
        users[userIndex].password = newPassword;
        users[userIndex].divisi = newDivisi;
        users[userIndex].email = newEmail;

        localStorage.setItem("userAccounts", JSON.stringify(users));
        editMessage.textContent = "Data user berhasil diupdate!";
        editMessage.style.color = 'var(--success-color)';

        // Reload user table to show changes
        setTimeout(() => {
            closeModal('modalEditUser');
            showPage('tambahPemain');
        }, 1000);
    }

    function deleteUser(usernameToDelete) {
        if (usernameToDelete === "admin") {
            alert("Tidak bisa menghapus akun admin.");
            return;
        }
        if (confirm(`Apakah Anda yakin ingin menghapus user ${usernameToDelete}?`)) {
            let users = JSON.parse(localStorage.getItem("userAccounts"));
            users = users.filter(user => user.username !== usernameToDelete);
            localStorage.setItem("userAccounts", JSON.stringify(users));
            showPage('tambahPemain'); // Reload user table
        }
    }

    // --- Activity and Timer Functions ---
    function submitShift(shift) {
        const currentUser = localStorage.getItem("currentUser");
        const userActivities = JSON.parse(localStorage.getItem("userActivities") || "{}");
        const today = new Date().toDateString();
        const now = new Date();

        if (!userActivities[currentUser]) {
            userActivities[currentUser] = {};
        }
        if (!userActivities[currentUser][today]) {
            userActivities[currentUser][today] = {};
        }

        userActivities[currentUser][today].absenMasuk = {
            shift: shift,
            waktu: now.toLocaleString('id-ID')
        };

        userActivities[currentUser][today].totalWorkTime = "00:00:00"; // Initialize total work time

        localStorage.setItem("userActivities", JSON.stringify(userActivities));
        closeModal('modalAbsenMasuk');

        // Save to Google Sheet
        saveActivity(currentUser, 'Absen Masuk', `Shift ${shift}`, now.toLocaleString('id-ID'), '-');

        const welcomeMessage = document.getElementById("welcomeMessage");
        welcomeMessage.innerHTML = `Anda telah absen untuk **Shift ${shift}**. Selamat bekerja!`;
    }

    function startIzinTimer(izinType) {
        const container = document.getElementById('izinTimerContainer');
        container.innerHTML = `
            <div id="timer-container">
                <p id="timer-info">Waktu Izin: ${izinType}</p>
                <h3 id="timer-display">00:00:00</h3>
                <button class="timer-btn stop" onclick="stopIzinTimer()">Selesai Izin</button>
                <div id="timer-alert"></div>
            </div>
        `;
        container.classList.add('start-timer');
        currentIzinType = izinType;
        izinTimerSeconds = 0;
        timerWarningShown = false;

        timerInterval = setInterval(updateIzinTimer, 1000);

        closeModal('modalPilihanIzin');
    }

    function updateIzinTimer() {
        izinTimerSeconds++;
        const display = document.getElementById('timer-display');
        const alert = document.getElementById('timer-alert');
        const container = document.getElementById('timer-container');

        display.textContent = formatTime(izinTimerSeconds);

        // Show warning at 20 minutes
        if (izinTimerSeconds >= 20 * 60 && !timerWarningShown) {
            alert.textContent = "Waktu izin Anda sudah 20 menit!";
            container.classList.add('warning');
            timerWarningShown = true;
        }
    }

    function stopIzinTimer() {
        clearInterval(timerInterval);

        const currentUser = localStorage.getItem("currentUser");
        const userActivities = JSON.parse(localStorage.getItem("userActivities") || "{}");
        const today = new Date().toDateString();
        const now = new Date();
        const formattedDuration = formatTime(izinTimerSeconds);

        if (userActivities[currentUser] && userActivities[currentUser][today]) {
            if (!userActivities[currentUser][today].izin) {
                userActivities[currentUser][today].izin = [];
            }
            userActivities[currentUser][today].izin.push({
                keterangan: currentIzinType,
                waktuMulai: now.toLocaleString('id-ID'),
                durasi: formattedDuration
            });

            localStorage.setItem("userActivities", JSON.stringify(userActivities));
            
            // Save to Google Sheet
            saveActivity(currentUser, 'Izin', `${currentIzinType} (${formattedDuration})`, now.toLocaleString('id-ID'), formattedDuration);
        }

        const container = document.getElementById('izinTimerContainer');
        container.classList.add('stop-timer');
        setTimeout(() => {
            container.innerHTML = '';
            container.classList.remove('start-timer', 'stop-timer');
        }, 500);
    }

    function confirmAbsenPulang() {
        const currentUser = localStorage.getItem("currentUser");
        const userActivities = JSON.parse(localStorage.getItem("userActivities") || "{}");
        const today = new Date().toDateString();
        const now = new Date();

        if (userActivities[currentUser] && userActivities[currentUser][today] && userActivities[currentUser][today].absenMasuk) {
            const absenMasukTime = new Date(userActivities[currentUser][today].absenMasuk.waktu);
            const timeDiffSeconds = Math.floor((now - absenMasukTime) / 1000);

            userActivities[currentUser][today].absenPulang = {
                waktu: now.toLocaleString('id-ID')
            };
            userActivities[currentUser][today].totalWorkTime = formatTime(timeDiffSeconds);

            localStorage.setItem("userActivities", JSON.stringify(userActivities));
            closeModal('modalAbsenPulang');
            
            // Save to Google Sheet
            saveActivity(currentUser, 'Absen Pulang', '-', now.toLocaleString('id-ID'), '-');
            
            showPage('historyAktivitas');
        } else {
            alert("Anda belum absen masuk hari ini.");
            closeModal('modalAbsenPulang');
        }
    }

    // --- Helper Functions ---
    function formatTime(seconds) {
        const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
        const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
        const s = String(seconds % 60).padStart(2, '0');
        return `${h}:${m}:${s}`;
    }

    function parseDurationToSeconds(duration) {
        const parts = duration.split(':').map(Number);
        return parts[0] * 3600 + parts[1] * 60 + parts[2];
    }
    
    // --- New functions to send data to Apps Script ---
    async function sendDataToAppsScript(data) {
        try {
            const response = await fetch(appsScriptUrl, {
                method: 'POST',
                body: new URLSearchParams(data)
            });
            const result = await response.json();
            console.log(result.message);
            return result;
        } catch (error) {
            console.error('Error sending data to Apps Script:', error);
            return { success: false, message: 'Failed to connect to server.' };
        }
    }

    function saveRegistration(userData) {
        const data = {
            action: 'register',
            namaLengkap: userData.nama,
            username: userData.username,
            password: userData.password,
            divisi: userData.divisi,
            email: userData.email,
        };
        sendDataToAppsScript(data);
    }
    
    function saveActivity(username, activity, description, startTime, duration) {
        const data = {
            action: 'submitActivity',
            username: username,
            aktivitas: activity,
            keterangan: description,
            waktuMulai: startTime,
            durasi: duration,
        };
        sendDataToAppsScript(data);
    }
</script>
